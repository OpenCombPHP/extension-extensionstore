<h2>{=$page_h1}</h2>
<msgqueue />
<form method="post" enctype="multipart/form-data">
	<div class="coresystem-form-title">
		<span>扩展名称</span>
		<widget id="extension_title" /> 
		<widget id="extension_title_bold" /> 
		<widget id="extension_title_italic" /> 
		<widget id="extension_title_strikethrough" /> 
		<label>颜色: <widget id="extension_title_color"/></label> 
		<div id='extension_color_selecter'></div>
	</div>
	<label><div class="coresystem-form-url"><span>扩展链接</span><widget id="extension_url" /></div></label>
	<label><div class="coresystem-form-select"><span>所属分类</span><widget id="extension_cat" /></div></label>
	<label><div class="coresystem-form-textarea"><!--<span>扩展内容</span>--><widget id="extension_content" /></div></label>
	<if "$theModel->child('attachments')->childrenCount() > 0 and get_class($theController) == 'org\opencomb\extensionstore\extension\EditExtension'">
		<div class='extension_exist_files_list'>
			<span>已有附件:</span>
			<!-- 已上传文件的容器 -->
			{?$nAttaMaxIndex=0}
			<foreach for='$theModel->child("attachments")' item='aAttaModel'>
				<div class='extension_exist_file'>
					<a href='{=$theController->getAttachmentUrl($aAttaModel)}'>{=$aAttaModel['orginname']}</a>
					{=$theController->getAttachmentSize($aAttaModel)}
					<a href='#' class='extension_exist_files_into_content' index='{=$aAttaModel['index']}' title='将附件插入到文档中,如果是图片就当作插图显示,如果是文件就插入链接'>插入到扩展</a>
					<label><input name='extension_exist_list[]' class='extension_exist_list' type='checkbox' value='{=$aAttaModel['index']}' {=$theController->getIsDisplayInList($aAttaModel)}/>显示在附件列表</label>
					<label><input name='extension_exist_file_delete[]' class='extension_exist_files_delete' type='checkbox' value='{=$aAttaModel['index']}'/>删除此附件</label>
				</div>
				{?$nAttaMaxIndex = $aAttaModel['index']} 
			</foreach>
			<script>
				file_num = {=$nAttaMaxIndex+1};
			</script>
		</div>
	</if>
	
	<div class='extension_files_list'>
		<span>新增附件:</span>
		<!-- 上传新文件的容器 -->
	</div>
	
	<input id='add_file' type="button" value="添加附件" />
	<input id='extension_files_index' name='extension_files_index' type="hidden" />
	<br/>
	<input type='submit' value="{=$save_button}" class="coresystem-form-button" />
</form>

<!-- 上传文件的部分,只是模板,js根据情况动态添加到容器中 -->
<div class='extension_file_template' style='display:none'>
	<input name='extension_files[]' class='extension_file_input' type='file' value="扩展附件" />
	<a href='#' class='extension_files_into_content' index='1' title='将附件插入到文档中,如果是图片就当作插图显示,如果是文件就插入链接'>插入到扩展</a>
	<label><input name="extension_list[]" class='extension_list' type='checkbox' value='1' checked/>显示在附件列表</label>
	<a href='#' class='extension_files_delete'>删除</a>
</div>
<!-- end 上传文件的部分,只是模板 -->

<lib name='jquery'/>
<lib name='jquery.farbtastic'/>
<script>
jquery(function(){
	//动态增加传文件框体
	if(typeof file_num == 'undefined'){
		file_num = 1; //附件计数
	}
	var extension_file = jquery('.extension_file_template').clone();
	extension_file.removeClass('extension_file_template').addClass('extension_file').css({'display':'block'});
	
	jquery('#add_file').click(function(){
		var extension_file_clone = extension_file.clone();
		extension_file_clone.find('.extension_list').val(file_num);
		extension_file_clone.find('.extension_files_into_content').attr('index',file_num);
		file_num++;
		jquery('.extension_files_list').append(extension_file_clone);
		serializeFilesIndex();
	});
	jquery('#add_file').click();//添加默认的一个文件上传框体
	serializeFilesIndex();
	
	//附件插入正文
	jquery('.extension_files_into_content , .extension_exist_files_into_content').live('click',function(){
		CKEDITOR.instances.extension_content.insertText('[attachment '+jquery(this).attr('index')+']');
		return false;
	});
	
	//删除新增附件(未上传)
	jquery('.extension_files_delete').live('click',function(){
		jquery(this).parents('.extension_file:first').remove();
		serializeFilesIndex();
		return false;
	});
	
	function serializeFilesIndex(){
		var arrIndexs = new Array();
		jquery('.extension_file').each(function(b,v){
			arrIndexs.push(jquery(v).find('.extension_files_into_content').attr('index'));
		});
		
		jquery('#extension_files_index').val(arrIndexs.join(','));
	}
	
	//颜色选择器
    jquery('#extension_color_selecter').farbtastic('#extension_title_color');
	jquery('#extension_title_color').focusin(function(){
		jquery('#extension_color_selecter')
		.css({
			'top':jquery(this).position().top + jquery(this).outerHeight(),
			'left':jquery(this).position().left,
		})
		.show();
	});
	jquery('#extension_title_color').focusout(function(){
		jquery('#extension_color_selecter').hide();
	});
});
</script>